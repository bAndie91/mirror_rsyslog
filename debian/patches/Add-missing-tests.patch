From: Michael Biebl <biebl@debian.org>
Date: Sun, 20 Dec 2015 17:07:20 +0100
Subject: Add missing tests

Those test files were missing the dist tarball

See https://github.com/rsyslog/rsyslog/pull/707
---
 tests/json_null-vg.sh                 | 15 +++++++++++++++
 tests/json_null.sh                    | 15 +++++++++++++++
 tests/json_null_array-vg.sh           | 14 ++++++++++++++
 tests/json_null_array.sh              | 14 ++++++++++++++
 tests/testsuites/json_null.conf       | 14 ++++++++++++++
 tests/testsuites/json_null_array.conf | 12 ++++++++++++
 6 files changed, 84 insertions(+)
 create mode 100644 tests/json_null-vg.sh
 create mode 100644 tests/json_null.sh
 create mode 100644 tests/json_null_array-vg.sh
 create mode 100644 tests/json_null_array.sh
 create mode 100644 tests/testsuites/json_null.conf
 create mode 100644 tests/testsuites/json_null_array.conf

diff --git a/tests/json_null-vg.sh b/tests/json_null-vg.sh
new file mode 100644
index 0000000..b25d189
--- /dev/null
+++ b/tests/json_null-vg.sh
@@ -0,0 +1,15 @@
+#!/bin/bash
+# added 2015-11-17 by rgerhards
+# This file is part of the rsyslog project, released under ASL 2.0
+# Note: the aim of this test is to test against misadressing, so we do
+# not actually check the output
+echo ===============================================================================
+echo \[json_null.sh\]: test for json containung \"null\" value
+. $srcdir/diag.sh init
+. $srcdir/diag.sh startup-vg json_null.conf
+. $srcdir/diag.sh tcpflood -m 1 -M "\"<167>Mar  6 16:57:54 172.20.245.8 test: @cee: { \\\"nope\\\": null }\""
+echo doing shutdown
+. $srcdir/diag.sh shutdown-when-empty
+echo wait on shutdown
+. $srcdir/diag.sh wait-shutdown-vg
+. $srcdir/diag.sh exit
diff --git a/tests/json_null.sh b/tests/json_null.sh
new file mode 100644
index 0000000..b51f6e4
--- /dev/null
+++ b/tests/json_null.sh
@@ -0,0 +1,15 @@
+#!/bin/bash
+# added 2015-11-17 by rgerhards
+# This file is part of the rsyslog project, released under ASL 2.0
+# Note: the aim of this test is to test against misadressing, so we do
+# not actually check the output
+echo ===============================================================================
+echo \[json_null.sh\]: test for json containung \"null\" value
+. $srcdir/diag.sh init
+. $srcdir/diag.sh startup json_null.conf
+. $srcdir/diag.sh tcpflood -m 1 -M "\"<167>Mar  6 16:57:54 172.20.245.8 test: @cee: { \\\"nope\\\": null }\""
+echo doing shutdown
+. $srcdir/diag.sh shutdown-when-empty
+echo wait on shutdown
+. $srcdir/diag.sh wait-shutdown
+. $srcdir/diag.sh exit
diff --git a/tests/json_null_array-vg.sh b/tests/json_null_array-vg.sh
new file mode 100644
index 0000000..8cd50c5
--- /dev/null
+++ b/tests/json_null_array-vg.sh
@@ -0,0 +1,14 @@
+#!/bin/bash
+# added 2015-11-17 by rgerhards
+# This file is part of the rsyslog project, released under ASL 2.0
+echo ===============================================================================
+echo \[json_null_array.sh\]: test for json containung \"null\" value
+. $srcdir/diag.sh init
+. $srcdir/diag.sh startup-vg json_null_array.conf
+. $srcdir/diag.sh tcpflood -m 1 -M "\"<167>Mar  6 16:57:54 172.20.245.8 test: @cee: { \\\"array\\\": [0, 1, null, 2, 3, null, 4] }\""
+echo doing shutdown
+. $srcdir/diag.sh shutdown-when-empty
+echo wait on shutdown
+. $srcdir/diag.sh wait-shutdown-vg
+. $srcdir/diag.sh seq-check 0 4
+. $srcdir/diag.sh exit
diff --git a/tests/json_null_array.sh b/tests/json_null_array.sh
new file mode 100644
index 0000000..4fe4ef7
--- /dev/null
+++ b/tests/json_null_array.sh
@@ -0,0 +1,14 @@
+#!/bin/bash
+# added 2015-11-17 by rgerhards
+# This file is part of the rsyslog project, released under ASL 2.0
+echo ===============================================================================
+echo \[json_null_array.sh\]: test for json containung \"null\" value
+. $srcdir/diag.sh init
+. $srcdir/diag.sh startup json_null_array.conf
+. $srcdir/diag.sh tcpflood -m 1 -M "\"<167>Mar  6 16:57:54 172.20.245.8 test: @cee: { \\\"array\\\": [0, 1, null, 2, 3, null, 4] }\""
+echo doing shutdown
+. $srcdir/diag.sh shutdown-when-empty
+echo wait on shutdown
+. $srcdir/diag.sh wait-shutdown
+. $srcdir/diag.sh seq-check 0 4
+. $srcdir/diag.sh exit
diff --git a/tests/testsuites/json_null.conf b/tests/testsuites/json_null.conf
new file mode 100644
index 0000000..5b4ea56
--- /dev/null
+++ b/tests/testsuites/json_null.conf
@@ -0,0 +1,14 @@
+$IncludeConfig diag-common.conf
+module(load="../plugins/mmjsonparse/.libs/mmjsonparse")
+module(load="../plugins/imtcp/.libs/imtcp")
+input(type="imtcp" port="13514")
+
+# we must make sure the template contains a reference to the 
+# data item with null value
+template(name="outfmt" type="string" string="%$!nope%\n")
+template(name="outfmt-all-json" type="string" string="%$!all-json%\n")
+
+action(type="mmjsonparse")
+action(type="omfile" file="./rsyslog.out.log" template="outfmt")
+if $!nope == "" then
+	action(type="omfile" file="./rsyslog2.out.log" template="outfmt-all-json")
diff --git a/tests/testsuites/json_null_array.conf b/tests/testsuites/json_null_array.conf
new file mode 100644
index 0000000..e8032c7
--- /dev/null
+++ b/tests/testsuites/json_null_array.conf
@@ -0,0 +1,12 @@
+$IncludeConfig diag-common.conf
+module(load="../plugins/mmjsonparse/.libs/mmjsonparse")
+module(load="../plugins/imtcp/.libs/imtcp")
+input(type="imtcp" port="13514")
+
+template(name="outfmt" type="string" string="%$.data%\n")
+
+action(type="mmjsonparse")
+foreach ($.data in $!array) do {
+	if not ($.data == "") then
+		action(type="omfile" file="rsyslog.out.log" template="outfmt")
+}
